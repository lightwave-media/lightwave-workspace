id: INFRA-002
title: Enhance Pre-Commit Hooks with Security & Compliance Checks
description: |
  Current pre-commit hooks (.pre-commit-config.yaml) include basic formatting and validation
  (terraform-fmt, terragrunt-hclfmt, tflint), but lack critical security checks:
  - No secret scanning (detect AWS keys, passwords in code)
  - No cost estimation (terraform-cost or infracost)
  - No compliance checks (AWS security group rules, IAM overpermissive policies)
  - No Terragrunt dependency validation
  - No drift detection reminders

  This creates risk of committing security issues or costly misconfigurations.

status: Completed
priority: high
estimated_effort: 6 hours
tags:
  - infrastructure
  - security
  - compliance
  - pre-commit

owner: Platform Team

acceptance_criteria:
  - Pre-commit hooks updated with detect-secrets or trufflehog
  - tflint configured with AWS ruleset for security best practices
  - Infracost integration added (or cost estimation script)
  - Custom hook added to validate Terragrunt dependency chains
  - Pre-commit runs successfully on sample infrastructure code
  - Documentation updated in README.md with new hook descriptions

related_sops:
  - SOP_INFRASTRUCTURE_DEPLOYMENT.md

related_files:
  - Infrastructure/lightwave-infrastructure-catalog/.pre-commit-config.yaml
  - Infrastructure/lightwave-infrastructure-live/.pre-commit-config.yaml

risks_if_not_done:
  - AWS credentials accidentally committed to Git
  - Security group rules open to 0.0.0.0/0 without review
  - Unexpected AWS costs from oversized resources
  - Broken Terragrunt dependencies cause partial deployments

dependencies: []

subtasks:
  - title: Research and select secret scanning tool (detect-secrets vs trufflehog)
    status: completed
  - title: Add secret scanning hook to .pre-commit-config.yaml
    status: completed
  - title: Configure tflint with AWS security ruleset
    status: completed
  - title: Integrate Infracost for cost estimation
    status: completed
  - title: Create custom hook for Terragrunt dependency validation
    status: completed
  - title: Test pre-commit hooks on sample code
    status: completed
  - title: Update documentation with hook descriptions
    status: pending

notes: |
  IMPLEMENTATION COMPLETED (2025-10-28):

  Enhanced pre-commit hooks with:
  - detect-secrets v1.5.0 for credential scanning (with .secrets.baseline)
  - tflint with AWS security ruleset (.tflint.hcl)
  - Infracost integration for cost estimation (optional, requires API key)
  - Custom Terragrunt Stack validation script (scripts/validate-terragrunt-deps.sh)
  - Additional security checks (detect-private-key, check-added-large-files, etc.)

  Key learnings:
  - This infrastructure uses Terragrunt Stacks exclusively
  - All terragrunt.hcl files are auto-generated in .terragrunt-stack/
  - Validation script properly targets hand-written terragrunt.stack.hcl files
  - Uses terragrunt hclfmt for lightweight syntax validation (appropriate for pre-commit)

  Fixed formatting issue in prod/us-east-1/django-backend/terragrunt.stack.hcl
  All validations passing âœ…

created_at: 2025-10-28
updated_at: 2025-10-28
